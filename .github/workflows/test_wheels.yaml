name: Test zxing-cpp wheels

on:
  workflow_dispatch:

env:
  TEST_LIBRARY: zxing-cpp

jobs:
  test-wheel:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            wheel: wheels/zxing_cpp-2.3.0-cp314-cp314-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl
          - os: ubuntu-latest-arm64
            wheel: wheels/zxing_cpp-2.3.0-cp314-cp314-manylinux_2_26_aarch64.manylinux_2_28_aarch64.whl
          - os: windows-latest
            wheel: wheels/zxing_cpp-2.3.0-cp314-cp314-win_amd64.whl

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Setup UV
        uses: astral-sh/setup-uv@5a7eac68fb9809dea845d802897dc5c723910fa3 # v7.1.3
        with:
          activate-environment: true
          enable-cache: false
          cache-dependency-glob: ""

      - name: Select wheel based on runner architecture
        id: select-wheel
        shell: bash
        run: |
          WHEEL_PATH="${{ matrix.wheel }}"
          
          echo "Using wheel: $WHEEL_PATH"
          echo "wheel_path=$WHEEL_PATH" >> "$GITHUB_OUTPUT"

      - name: Install test dependencies
        run: uv pip install pytest tomli tomli-w

      - name: Update pyproject.toml with selected wheel
        working-directory: libs/${{ env.TEST_LIBRARY }}
        shell: bash
        run: |
          # Using python to reliably edit the toml file cross-platform
          python -c "
          import tomli
          import tomli_w

          pyproject_path = 'pyproject.toml'
          wheel_path = '${{ steps.select-wheel.outputs.wheel_path }}'

          with open(pyproject_path, 'rb') as f:
              data = tomli.load(f)

          data['tool']['uv']['sources']['zxing-cpp']['path'] = wheel_path

          with open(pyproject_path, 'wb') as f:
              tomli_w.dump(data, f)
          "

      - name: Install dependencies using uv
        working-directory: libs/${{ env.TEST_LIBRARY }}
        run: uv pip install .

      - name: Run tests with pytest
        working-directory: libs/${{ env.TEST_LIBRARY }}
        run: pytest
